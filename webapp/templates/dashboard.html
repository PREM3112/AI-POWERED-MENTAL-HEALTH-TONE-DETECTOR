<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .emotion-card {
            border-left: 5px solid;
            transition: transform 0.2s;
        }
        .emotion-card:hover {
            transform: translateY(-2px);
        }
        .anxious { border-left-color: #FF9800; }
        .stressed { border-left-color: #9C27B0; }
        .sad { border-left-color: #2196F3; }
        .happy { border-left-color: #4CAF50; }
        .angry { border-left-color: #f44336; }
        .depressed { border-left-color: #607D8B; }
        .neutral { border-left-color: #9E9E9E; }
        
        .progress-bar {
            transition: width 1s ease-in-out;
        }
        .voice-visualizer {
            height: 100px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            margin: 10px 0;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .history-item {
            border-left: 3px solid;
            padding-left: 15px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-brain me-2"></i>
                Mental Health Detector
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i> {{ user }}
                </span>
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/debug">Debug</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1><i class="fas fa-tachometer-alt me-2"></i>Mental Health Dashboard</h1>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="clearHistory()">
                            <i class="fas fa-trash me-1"></i>Clear History
                        </button>
                        <button class="btn btn-outline-info" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                <p class="text-muted">Monitor your emotional well-being with AI-powered analysis</p>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="row">
            <!-- Text Analysis -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-keyboard me-2"></i>Text Analysis</h5>
                    </div>
                    <div class="card-body">
                        <form id="textAnalysisForm">
                            <div class="mb-3">
                                <label for="analysisText" class="form-label">How are you feeling?</label>
                                <textarea class="form-control" id="analysisText" rows="4" 
                                          placeholder="Describe your thoughts and feelings..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="analyzeBtn">
                                <i class="fas fa-robot me-2"></i>Analyze with AI
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Voice Analysis -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-microphone me-2"></i>Voice Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Record your voice</label>
                            <div class="voice-visualizer d-flex align-items-center justify-content-center text-white" id="visualizer">
                                <div id="recordingStatus" class="text-center">
                                    <i class="fas fa-microphone fa-2x mb-2"></i>
                                    <p class="mb-0">Click record to start</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-success" onclick="startRecording()" id="recordBtn">
                                <i class="fas fa-record-vinyl me-2"></i>Record
                            </button>
                            <button type="button" class="btn btn-danger" onclick="stopRecording()" id="stopBtn" disabled>
                                <i class="fas fa-stop me-2"></i>Stop
                            </button>
                            <button type="button" class="btn btn-warning" onclick="analyzeRecording()" id="analyzeVoiceBtn" disabled>
                                <i class="fas fa-brain me-2"></i>Analyze
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Or upload audio file</label>
                            <input type="file" class="form-control" id="audioUpload" accept="audio/*">
                            <button class="btn btn-outline-secondary mt-2 w-100" onclick="uploadAudio()">
                                <i class="fas fa-upload me-2"></i>Upload & Analyze
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="analysisResults" style="display: none;">
                            <!-- Results will be dynamically inserted here -->
                        </div>
                        <div id="noResults" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p>No analysis performed yet. Use text or voice input to get started.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History & Care Plan -->
        <div class="row">
            <!-- History -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent History</h5>
                    </div>
                    <div class="card-body">
                        <div id="historyList">
                            {% if mood_history %}
                                {% for entry in mood_history %}
                                <div class="history-item {{ entry.emotion }}">
                                    <div class="d-flex justify-content-between">
                                        <strong class="text-capitalize">{{ entry.emotion }}</strong>
                                        <small class="text-muted">{{ entry.created_at.strftime('%H:%M') if entry.created_at else 'Recent' }}</small>
                                    </div>
                                    {% if entry.text_input %}
                                    <p class="mb-1 small">{{ entry.text_input[:100] }}{% if entry.text_input|length > 100 %}...{% endif %}</p>
                                    {% endif %}
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" style="width: {{ (entry.confidence * 100)|default(70) }}%;"></div>
                                    </div>
                                    <small class="text-muted">Confidence: {{ "%.0f"|format((entry.confidence * 100)|default(70)) }}%</small>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted text-center">No history available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Care Plan -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-heart me-2"></i>Your Care Plan</h5>
                    </div>
                    <div class="card-body">
                        <div id="carePlanContent">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Generating personalized care plan...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p id="loadingMessage">Analyzing your input...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRecordingId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;

        // Text Analysis
        document.getElementById('textAnalysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = document.getElementById('analysisText').value.trim();
            
            if (!text) {
                alert('Please enter some text to analyze');
                return;
            }

            await analyzeText(text);
        });

        // Voice Recording Functions
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingStartTime = Date.now();

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    currentRecordingId = 'recording_' + Date.now();
                    // In a real app, you'd upload this blob to your server
                    console.log('Recording stopped, duration:', (Date.now() - recordingStartTime) / 1000);
                };

                mediaRecorder.start();
                updateRecordingUI(true);
                
                // Visual feedback
                animateVisualizer();
                
            } catch (error) {
                console.error('Recording failed:', error);
                alert('Microphone access denied or not available');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                updateRecordingUI(false);
                
                // For demo purposes, we'll simulate a recording
                simulateRecordingAnalysis();
            }
        }

        function updateRecordingUI(isRecording) {
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const analyzeBtn = document.getElementById('analyzeVoiceBtn');
            const status = document.getElementById('recordingStatus');
            const visualizer = document.getElementById('visualizer');

            if (isRecording) {
                recordBtn.disabled = true;
                stopBtn.disabled = false;
                analyzeBtn.disabled = true;
                status.innerHTML = '<i class="fas fa-circle fa-beat fa-2x text-danger mb-2"></i><p class="mb-0">Recording...</p>';
                visualizer.classList.add('pulse');
            } else {
                recordBtn.disabled = false;
                stopBtn.disabled = true;
                analyzeBtn.disabled = false;
                status.innerHTML = '<i class="fas fa-check-circle fa-2x text-success mb-2"></i><p class="mb-0">Ready to analyze</p>';
                visualizer.classList.remove('pulse');
            }
        }

        function animateVisualizer() {
            const visualizer = document.getElementById('visualizer');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Simple animation for demo
                const intensity = Math.random() * 20 + 10;
                visualizer.style.background = `linear-gradient(45deg, #667eea 0%, #764ba2 ${intensity}%)`;
                setTimeout(animateVisualizer, 100);
            }
        }

        async function analyzeRecording() {
            showLoading('Analyzing your voice...');
            
            try {
                // Simulate recording analysis for demo
                const response = await fetch('/analyze-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        filename: `demo_recording_${Date.now()}.wav`,
                        duration: 5 
                    })
                });

                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    displayResults(result);
                    loadCarePlan();
                    loadHistory();
                } else {
                    alert('Analysis failed: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                alert('Analysis failed. Please try again.');
                console.error('Analysis error:', error);
            }
        }

        function simulateRecordingAnalysis() {
            // This would be replaced with actual file upload in production
            console.log('Simulating recording analysis...');
        }

        async function uploadAudio() {
            const fileInput = document.getElementById('audioUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an audio file');
                return;
            }

            showLoading('Uploading and analyzing audio...');

            const formData = new FormData();
            formData.append('audio', file);

            try {
                const response = await fetch('/upload-audio', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    // Now analyze the uploaded file
                    const analysisResponse = await fetch('/analyze-audio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: result.filename })
                    });

                    const analysisResult = await analysisResponse.json();
                    hideLoading();
                    
                    if (analysisResult.success) {
                        displayResults(analysisResult);
                        loadCarePlan();
                        loadHistory();
                    } else {
                        alert('Analysis failed: ' + analysisResult.error);
                    }
                } else {
                    hideLoading();
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                alert('Upload failed. Please try again.');
                console.error('Upload error:', error);
            }
        }

        async function analyzeText(text) {
            showLoading('Analyzing your text...');
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    displayResults(result);
                    document.getElementById('analysisText').value = '';
                    loadCarePlan();
                    loadHistory();
                } else {
                    alert('Analysis failed: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                alert('Analysis failed. Please try again.');
                console.error('Analysis error:', error);
            }
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('analysisResults');
            const noResultsDiv = document.getElementById('noResults');
            const advice = result.advice;
            
            resultsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card emotion-card ${result.emotion}">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-${getEmotionIcon(result.emotion)} me-2"></i>
                                    ${result.emotion.toUpperCase()}
                                </h5>
                                <p class="card-text">Detected with ${(result.confidence * 100).toFixed(1)}% confidence</p>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-${getEmotionColor(result.emotion)}" 
                                         style="width: ${result.confidence * 100}%"></div>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-${result.input_type === 'text' ? 'keyboard' : 'microphone'} me-1"></i>
                                    ${result.input_type} analysis
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card" style="border-left: 5px solid ${advice.color || '#6c757d'}">
                            <div class="card-body">
                                <h6 class="card-title text-primary">
                                    <i class="fas fa-hands-helping me-2"></i>Recommendations
                                </h6>
                                
                                <h6 class="mt-3">Immediate Actions:</h6>
                                <ul class="small">
                                    ${advice.immediate_actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>
                                
                                <h6 class="mt-3">Long-term Strategies:</h6>
                                <ul class="small">
                                    ${advice.long_term_strategies.map(strategy => `<li>${strategy}</li>`).join('')}
                                </ul>
                                
                                <div class="alert alert-${advice.urgency_level === 'high' ? 'danger' : 'info'} mt-3">
                                    <strong>Professional Guidance:</strong> ${advice.professional_guidance}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            noResultsDiv.style.display = 'none';
        }

        async function loadCarePlan() {
            try {
                const response = await fetch('/care_plan');
                const carePlan = await response.json();
                
                document.getElementById('carePlanContent').innerHTML = `
                    <h6 class="text-primary">${carePlan.weekly_focus}</h6>
                    <p class="small text-muted">Weekly Focus Area</p>
                    
                    <h6 class="mt-3">Daily Practices:</h6>
                    <ul class="small">
                        ${carePlan.daily_practices.map(practice => `<li>${practice}</li>`).join('')}
                    </ul>
                    
                    <h6 class="mt-3">Weekly Goals:</h6>
                    <ul class="small">
                        ${carePlan.weekly_goals.map(goal => `<li>${goal}</li>`).join('')}
                    </ul>
                `;
            } catch (error) {
                console.error('Failed to load care plan:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const history = await response.json();
                
                const historyList = document.getElementById('historyList');
                if (history.length === 0) {
                    historyList.innerHTML = '<p class="text-muted text-center">No history available</p>';
                    return;
                }
                
                historyList.innerHTML = history.slice(0, 10).map(entry => `
                    <div class="history-item ${entry.emotion}">
                        <div class="d-flex justify-content-between">
                            <strong class="text-capitalize">${entry.emotion}</strong>
                            <small class="text-muted">${new Date(entry.timestamp).toLocaleTimeString()}</small>
                        </div>
                        ${entry.text ? `<p class="mb-1 small">${entry.text}</p>` : ''}
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" style="width: ${entry.confidence * 100}%;"></div>
                        </div>
                        <small class="text-muted">Confidence: ${Math.round(entry.confidence * 100)}%</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        async function clearHistory() {
            if (confirm('Are you sure you want to clear your analysis history?')) {
                try {
                    await fetch('/clear_history', { method: 'POST' });
                    loadHistory();
                    document.getElementById('analysisResults').style.display = 'none';
                    document.getElementById('noResults').style.display = 'block';
                } catch (error) {
                    console.error('Failed to clear history:', error);
                }
            }
        }

        function refreshDashboard() {
            loadCarePlan();
            loadHistory();
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            new bootstrap.Modal(document.getElementById('loadingModal')).show();
        }

        function hideLoading() {
            bootstrap.Modal.getInstance(document.getElementById('loadingModal')).hide();
        }

        function getEmotionIcon(emotion) {
            const icons = {
                'happy': 'smile',
                'sad': 'sad-tear',
                'anxious': 'flushed',
                'angry': 'angry',
                'stressed': 'tired',
                'depressed': 'sad-cry',
                'neutral': 'meh'
            };
            return icons[emotion] || 'question-circle';
        }

        function getEmotionColor(emotion) {
            const colors = {
                'happy': 'success',
                'sad': 'primary',
                'anxious': 'warning',
                'angry': 'danger',
                'stressed': 'purple',
                'depressed': 'secondary',
                'neutral': 'dark'
            };
            return colors[emotion] || 'dark';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadCarePlan();
            loadHistory();
        });
    </script>
</body>
</html>